<?xml version="1.0"?>
<project
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"
	xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>com.ms.jedi.data.lineage</groupId>
		<artifactId>DL_Parent</artifactId>
		<version>1.0</version>
		<relativePath>../DL_Parent/pom.xml</relativePath>
	</parent>

	<artifactId>DL_Web</artifactId>
	<packaging>war</packaging>

	<properties>
		<webui.basedir>${project.basedir}/ui</webui.basedir>
		<timestamp>${maven.build.timestamp}</timestamp>
		<maven.build.timestamp.format>yyyy-MM-dd'T'HH:mm:ssX</maven.build.timestamp.format>
	</properties>

	<dependencies>
		<dependency>
			<groupId>junit</groupId>
			<artifactId>junit</artifactId>
			<version>3.8.1</version>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>commons-io</groupId>
			<artifactId>commons-io</artifactId>
		</dependency>
		<dependency>
			<groupId>org.json4s</groupId>
			<artifactId>json4s-ext_${scala.compat.version}</artifactId>
		</dependency>
		<dependency>
			<groupId>javax.servlet</groupId>
			<artifactId>javax.servlet-api</artifactId>
			<version>3.1.0</version>
			<scope>provided</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework</groupId>
			<artifactId>spring-webmvc</artifactId>
			<version>5.2.3.RELEASE</version>
		</dependency>
		<dependency>
			<groupId>org.thymeleaf</groupId>
			<artifactId>thymeleaf-spring5</artifactId>
			<version>3.0.9.RELEASE</version>
		</dependency>
		<dependency>
			<groupId>ch.qos.logback</groupId>
			<artifactId>logback-classic</artifactId>
		</dependency>
		<dependency>
			<groupId>org.mockito</groupId>
			<artifactId>mockito-core</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>de.sciss</groupId>
			<artifactId>scala-chart_${scala.compat.version}</artifactId>
			<version>0.6.0</version>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>com.ms.jedi.data.lineage</groupId>
			<artifactId>DL_Core</artifactId>
			<version>1.0</version>
		</dependency>
		<dependency>
			<groupId>com.ms.jedi.data.lineage</groupId>
			<artifactId>DL_Common</artifactId>
			<version>1.0</version>
		</dependency>
	</dependencies>
	<build>
		<finalName>datalineage-ui-${project.version}</finalName>
		<resources>
			<resource>
				<directory>src/main/resources</directory>
				<filtering>true</filtering>
			</resource>
		</resources>
		<sourceDirectory>src/main</sourceDirectory>
		<testSourceDirectory>src/test/scala</testSourceDirectory>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<version>3.6.1</version>
				<configuration>
					<source>${java.version}</source>
					<target>${java.version}</target>
					<encoding>UTF-8</encoding>
				</configuration>
			</plugin>
			<plugin>
				<groupId>net.alchim31.maven</groupId>
				<artifactId>scala-maven-plugin</artifactId>
				<version>3.2.1</version>
				<executions>
					<execution>
						<goals>
							<goal>compile</goal>
							<goal>testCompile</goal>
						</goals>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-install-plugin</artifactId>
				<version>2.5.2</version>
				<configuration>
					<skip>true</skip>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.codehaus.mojo</groupId>
				<artifactId>exec-maven-plugin</artifactId>
				<executions>
					<execution>
						<id>gen-ts-model-lineage</id>
						<phase>process-classes</phase>
						<goals>
							<goal>java</goal>
						</goals>
						<configuration>
							<includeProjectDependencies>true</includeProjectDependencies>
							<includePluginDependencies>true</includePluginDependencies>
							<executableDependency>
								<groupId>com.github.wajda</groupId>
								<artifactId>scala-ts_${scala.compat.version}</artifactId>
							</executableDependency>
							<mainClass>com.mpc.scalats.CLI</mainClass>
							<arguments>
								<argument>--out</argument>
								<argument>${project.basedir}/ui/src/generated-ts/lineage-model.ts</argument>
								<argument>--emit-interfaces</argument>
								<argument>--option-to-nullable</argument>
								<argument>com.ms.jedi.dl.model.PersistedDatasetDescriptor</argument>
								<argument>com.ms.jedi.dl.model.DataLineage</argument>
								<!-- workaround for a scala-ts bug -->
								<argument>com.ms.jedi.dl.model.op.OperationProps</argument>
							</arguments>
						</configuration>
					</execution>
					<execution>
						<id>gen-ts-model-operation</id>
						<phase>process-classes</phase>
						<goals>
							<goal>java</goal>
						</goals>
						<configuration>
							<includeProjectDependencies>true</includeProjectDependencies>
							<includePluginDependencies>true</includePluginDependencies>
							<executableDependency>
								<groupId>com.github.wajda</groupId>
								<artifactId>scala-ts_${scala.compat.version}</artifactId>
							</executableDependency>
							<mainClass>com.mpc.scalats.CLI</mainClass>
							<arguments>
								<argument>--out</argument>
								<argument>${project.basedir}/ui/src/generated-ts/operation-model.ts</argument>
								<argument>--emit-interfaces</argument>
								<argument>--option-to-nullable</argument>
								<argument>com.ms.jedi.dl.model.op.Operation</argument>
								<argument>com.ms.jedi.dl.model.op.Alias</argument>
								<argument>com.ms.jedi.dl.model.op.Write</argument>
								<argument>com.ms.jedi.dl.model.op.Filter</argument>
								<argument>com.ms.jedi.dl.model.op.Sort</argument>
								<argument>com.ms.jedi.dl.model.op.Aggregate</argument>
								<argument>com.ms.jedi.dl.model.op.Generic</argument>
								<argument>com.ms.jedi.dl.model.op.Join</argument>
								<argument>com.ms.jedi.dl.model.op.Union</argument>
								<argument>com.ms.jedi.dl.model.op.Projection</argument>
								<argument>com.ms.jedi.dl.model.op.Read</argument>
								<argument>com.ms.jedi.dl.model.op.Composite</argument>
								<!-- workaround for a scala-ts bug -->
								<argument>com.ms.jedi.dl.model.dt.DataType</argument>
							</arguments>
						</configuration>
					</execution>
					<execution>
						<id>gen-ts-model-expression</id>
						<phase>process-classes</phase>
						<goals>
							<goal>java</goal>
						</goals>
						<configuration>
							<includeProjectDependencies>true</includeProjectDependencies>
							<includePluginDependencies>true</includePluginDependencies>
							<executableDependency>
								<groupId>com.github.wajda</groupId>
								<artifactId>scala-ts_${scala.compat.version}</artifactId>
							</executableDependency>
							<mainClass>com.mpc.scalats.CLI</mainClass>
							<arguments>
								<argument>--out</argument>
								<argument>${project.basedir}/ui/src/generated-ts/expression-model.ts</argument>
								<argument>--emit-interfaces</argument>
								<argument>--option-to-nullable</argument>
								<argument>com.ms.jedi.dl.model.expr.Expression</argument>
								<argument>com.ms.jedi.dl.model.expr.AttrRef</argument>
								<argument>com.ms.jedi.dl.model.expr.Generic</argument>
								<argument>com.ms.jedi.dl.model.expr.GenericLeaf</argument>
								<argument>com.ms.jedi.dl.model.expr.Alias</argument>
								<argument>com.ms.jedi.dl.model.expr.Binary</argument>
								<argument>com.ms.jedi.dl.model.expr.UDF</argument>
								<argument>com.ms.jedi.dl.model.expr.Literal</argument>
							</arguments>
						</configuration>
					</execution>
					<execution>
						<id>gen-ts-model-datatype</id>
						<phase>process-classes</phase>
						<goals>
							<goal>java</goal>
						</goals>
						<configuration>
							<includeProjectDependencies>true</includeProjectDependencies>
							<includePluginDependencies>true</includePluginDependencies>
							<executableDependency>
								<groupId>com.github.wajda</groupId>
								<artifactId>scala-ts_${scala.compat.version}</artifactId>
							</executableDependency>
							<mainClass>com.mpc.scalats.CLI</mainClass>
							<arguments>
								<argument>--out</argument>
								<argument>${project.basedir}/ui/src/generated-ts/datatype-model.ts</argument>
								<argument>--emit-interfaces</argument>
								<argument>--option-to-nullable</argument>
								<argument>com.ms.jedi.dl.model.dt.DataType</argument>
								<argument>com.ms.jedi.dl.model.dt.Simple</argument>
								<argument>com.ms.jedi.dl.model.dt.Struct</argument>
								<argument>com.ms.jedi.dl.model.dt.Array</argument>
							</arguments>
						</configuration>
					</execution>
				</executions>
				<dependencies>
					<dependency>
						<groupId>com.github.wajda</groupId>
						<artifactId>scala-ts_${scala.compat.version}</artifactId>
						<version>0.4.0.0</version>
					</dependency>
				</dependencies>
			</plugin>

			<plugin>
				<artifactId>maven-antrun-plugin</artifactId>
				<version>1.7</version>
				<executions>
					<execution>
						<id>ui-package</id>
						<phase>prepare-package</phase>
						<configuration>
							<target name="ui-build">
								<echo>Preparing UI build</echo>
								<exec executable="cmd" dir="${webui.basedir}" osfamily="windows"
									failonerror="true">
									<arg line="/c npm install --no-color" />
								</exec>
								<exec executable="npm" dir="${webui.basedir}" osfamily="unix"
									failonerror="true">
									<arg line="install --no-color" />
								</exec>

								<echo>Executing UI build</echo>
								<exec executable="cmd" dir="${webui.basedir}" osfamily="windows"
									failonerror="true">
									<env key="SPLINE_VERSION" value="${project.version}" />
									<arg line="/c npm run prod-build --no-color" />
								</exec>
								<exec executable="npm" dir="${webui.basedir}" osfamily="unix"
									failonerror="true">
									<env key="SPLINE_VERSION" value="${project.version}" />
									<arg line="run prod-build --no-color" />
								</exec>
							</target>
						</configuration>
						<goals>
							<goal>run</goal>
						</goals>
					</execution>
				</executions>
			</plugin>

			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-war-plugin</artifactId>
				<version>2.2</version>
				<configuration>
					<failOnMissingWebXml>false</failOnMissingWebXml>
					<webResources>
						<resource>
							<directory>ui/dist</directory>
							<targetPath>/assets</targetPath>
							<filtering>false</filtering>
							<excludes>
								<exclude>dist/**/*.js.map</exclude>
							</excludes>
						</resource>
						<resource>
							<directory>ui/src</directory>
							<targetPath>/WEB-INF/html</targetPath>
							<filtering>true</filtering>
							<includes>
								<include>index.html</include>
								<include>errors/*.html</include>
							</includes>
						</resource>
						<resource>
							<directory>ui/src/static</directory>
							<targetPath>/</targetPath>
							<filtering>false</filtering>
						</resource>
					</webResources>
					<archive>
						<manifestEntries>
							<Build-Time>${maven.build.timestamp}</Build-Time>
						</manifestEntries>
					</archive>
				</configuration>
			</plugin>

			<plugin>
				<!-- http://tomcat.apache.org/maven-plugin-trunk/executable-war-jar.html -->
				<groupId>org.apache.tomcat.maven</groupId>
				<artifactId>tomcat7-maven-plugin</artifactId>
				<executions>
					<execution>
						<id>tomcat-run</id>
						<goals>
							<goal>exec-war-only</goal>
						</goals>
						<phase>package</phase>
						<configuration>
							<path>/</path>
							<finalName>${project.build.finalName}.exec.jar</finalName>
						</configuration>
					</execution>
				</executions>
			</plugin>
		</plugins>
	</build>

	<profiles>
		<profile>
			<id>license-check</id>
			<build>
				<plugins>
					<plugin>
						<groupId>org.apache.rat</groupId>
						<artifactId>apache-rat-plugin</artifactId>
						<configuration>
							<excludes combine.children="append">
								<exclude>ui/dist/**</exclude>
								<exclude>ui/node_modules/**</exclude>
								<exclude>ui/src/third-party-scripts/**</exclude>
								<exclude>ui/src/generated-ts/**</exclude>
							</excludes>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
	</profiles>
</project>
